<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üçâ Fruit Cut ‚Äî Offline + Fast Load</title>
<style>
:root{--ui:#f4f7fb;--btn:#111}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;font-family:Inter,system-ui,Roboto,sans-serif;background:var(--ui);color:#111;overflow:hidden}
.container{max-width:860px;margin:auto;padding:12px}
h1{text-align:center;margin:8px 0 10px}
.hud{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:8px}
.stat{background:#fff;padding:8px 12px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1);font-weight:700}
#gameWrapper{position:relative;border-radius:14px;overflow:hidden;background:linear-gradient(180deg,#bfe9ff,#f6f7fb);height:70vh;min-height:420px}
#gameArea{position:absolute;inset:0;touch-action:none;z-index:2}
canvas{position:absolute;inset:0;z-index:5;pointer-events:none}
.fruit,.half{position:absolute;transform:translate(-50%,-50%);user-select:none;pointer-events:none;z-index:3}
#bigStart{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:10;background:var(--btn);color:#fff;padding:14px 18px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:10px}
.btn{background:#fff;border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.consoleBox{position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.72);color:#fff;padding:8px;border-radius:8px;z-index:20;max-height:45%;overflow:auto;font-size:12px;font-family:monospace;display:none}
#loaderOverlay{position:absolute;inset:0;z-index:30;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fff}
#loaderBar{width:240px;height:12px;background:#eee;border-radius:12px;overflow:hidden;margin-top:10px}
#loaderFill{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#06b6d4)}
#loaderText{font-weight:700;margin-bottom:4px}
</style>
</head>
<body>
<div class="container">
  <h1>üçâ Fruit Cut ‚Äî Offline + Fast Load</h1>
  <div class="hud">
    <div class="stat">Score: <span id="score">0</span></div>
    <div class="stat">Lives: <span id="lives">3</span></div>
    <div class="stat">Coins: <span id="coins">0</span></div>
  </div>

  <div id="gameWrapper">
    <div id="gameArea"></div>
    <canvas id="bladeCanvas"></canvas>
    <canvas id="particles"></canvas>
    <div id="bigStart">START</div>
    <div id="consoleBox" class="consoleBox"></div>
    <div id="loaderOverlay">
      <div id="loaderText">Loading images...</div>
      <div id="loaderBar"><div id="loaderFill"></div></div>
    </div>
  </div>

  <div class="controls">
    <button id="startBtn" class="btn" disabled>Start</button>
    <button id="pauseBtn" class="btn">Pause</button>
    <button id="restartBtn" class="btn">Restart</button>
    <button id="toggleConsole" class="btn">Console</button>
  </div>
</div>

<script>
const FRUITS=['apple.png','banana.png','cantaloupe.png','guava.png','mango.png','orange.png','papaya.png','pear.png','pineapple.png','plum.png','pomegranate.png','strawberry.png','watermelon.png'];
const BOMB='bomb.png';
const PATH='images/';

const loaderOverlay=document.getElementById('loaderOverlay');
const loaderFill=document.getElementById('loaderFill');
const loaderText=document.getElementById('loaderText');
const area=document.getElementById('gameArea');
const startBtn=document.getElementById('startBtn');
const bigStart=document.getElementById('bigStart');
const pauseBtn=document.getElementById('pauseBtn');
const restartBtn=document.getElementById('restartBtn');
const consoleBox=document.getElementById('consoleBox');
const toggleConsole=document.getElementById('toggleConsole');
const scoreEl=document.getElementById('score');
const livesEl=document.getElementById('lives');
const coinsEl=document.getElementById('coins');
const bctx=document.getElementById('bladeCanvas').getContext('2d');
const pctx=document.getElementById('particles').getContext('2d');

let cache={},running=false,paused=false,score=0,lives=3,coins=0,fruits=[],particles=[],blade=[];

function log(...a){const s='[FruitCut] '+a.join(' ');console.log(s);const d=document.createElement('div');d.textContent=s;consoleBox.prepend(d);}
function rand(a,b){return Math.random()*(b-a)+a;}
function resize(){const r=area.getBoundingClientRect();bctx.canvas.width=r.width;bctx.canvas.height=r.height;pctx.canvas.width=r.width;pctx.canvas.height=r.height;}
window.addEventListener('resize',resize);

async function preload(){
  const all=[...FRUITS,BOMB];let loaded=0;
  await Promise.all(all.map(n=>new Promise(res=>{
    const i=new Image();i.onload=()=>{cache[n]=i;loaded++;update();res();};
    i.onerror=()=>{log('fail',n);loaded++;update();res();};
    i.src=PATH+n;
    function update(){loaderFill.style.width=(loaded/all.length*100)+'%';loaderText.textContent='Loading '+loaded+'/'+all.length;}
  })));
  loaderOverlay.style.display='none';
  startBtn.disabled=false;bigStart.style.display='block';
  log('Preload complete, cached',Object.keys(cache).length);
}

function spawn(){
  if(!running||paused)return;
  const isBomb=Math.random()<0.1;
  const name=isBomb?BOMB:FRUITS[Math.floor(Math.random()*FRUITS.length)];
  const img=cache[name]||new Image();img.src=PATH+name;
  const el=document.createElement('img');el.src=img.src;el.className='fruit';
  const size=Math.max(70,Math.min(120,Math.floor(area.clientWidth*0.15)));
  el.style.width=size+'px';
  const x=rand(60,area.clientWidth-60),y=area.clientHeight+40;
  el.style.left=x+'px';el.style.top=y+'px';
  area.appendChild(el);
  fruits.push({name,isBomb,x,y,vx:rand(-2,2),vy:-rand(12,15),rot:rand(-20,20),el,sliced:false});
}
function update(){
  for(let i=fruits.length-1;i>=0;i--){
    const f=fruits[i];f.vy+=0.35;f.x+=f.vx;f.y+=f.vy;f.el.style.left=f.x+'px';f.el.style.top=f.y+'px';
    if(f.y>area.clientHeight+80){f.el.remove();fruits.splice(i,1);}
  }
}
function draw(){
  bctx.clearRect(0,0,bctx.canvas.width,bctx.canvas.height);
  if(blade.length>1){
    bctx.strokeStyle='#22c55e';bctx.lineWidth=10;bctx.lineJoin='round';
    bctx.beginPath();bctx.moveTo(blade[0].x,blade[0].y);
    blade.forEach(p=>bctx.lineTo(p.x,p.y));bctx.stroke();
  }
}
function slice(f){
  if(f.sliced)return;f.sliced=true;
  if(f.isBomb){lives--;log('Bomb hit');if(lives<=0)end();}
  else{score+=10;coins++;}
  f.el.remove();fruits=fruits.filter(x=>x!==f);
  updateHUD();
}
function end(){running=false;alert('Game Over! Score: '+score);}
function updateHUD(){scoreEl.textContent=score;livesEl.textContent=lives;coinsEl.textContent=coins;}
function loop(){if(running&&!paused){update();draw();}requestAnimationFrame(loop);}

area.addEventListener('pointermove',e=>{
  if(!running||paused)return;
  const r=area.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;
  blade.push({x,y});if(blade.length>15)blade.shift();
  fruits.forEach(f=>{
    const fr=f.el.getBoundingClientRect();
    if(e.clientX>fr.left&&e.clientX<fr.right&&e.clientY>fr.top&&e.clientY<fr.bottom)slice(f);
  });
});
area.addEventListener('pointerup',()=>blade=[]);

function start(){if(running)return;running=true;paused=false;bigStart.style.display='none';setInterval(spawn,700);}
function pause(){paused=!paused;pauseBtn.textContent=paused?'Resume':'Pause';}
function restart(){location.reload();}

startBtn.onclick=start;bigStart.onclick=start;
pauseBtn.onclick=pause;restartBtn.onclick=restart;
toggleConsole.onclick=()=>consoleBox.style.display=consoleBox.style.display==='block'?'none':'block';

resize();preload();loop();

// ---- Service Worker Registration for Offline ----
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').then(()=>log('ServiceWorker registered')).catch(e=>log('SW fail',e));
  });
}
</script>

<!-- Service Worker inline -->
<script id="sw-script" type="javascript/worker">
const CACHE='fruitcut-v1';
const FILES=[
  './',
  './index.html',
  './images/apple.png','./images/banana.png','./images/bomb.png',
  './images/orange.png','./images/mango.png','./images/papaya.png',
  './images/pineapple.png','./images/strawberry.png','./images/watermelon.png'
];
self.addEventListener('install',e=>{
  e.waitUntil(caches.open(CACHE).then(c=>c.addAll(FILES)));
});
self.addEventListener('fetch',e=>{
  e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
    const copy=res.clone();caches.open(CACHE).then(c=>c.put(e.request,copy));return res;
  })));
});
</script>

<script>
// Write inline service worker to sw.js at runtime (GitHub Pages safe)
(async()=>{
  const code=document.getElementById('sw-script').textContent;
  const blob=new Blob([code],{type:'text/javascript'});
  const swURL=URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL);
})();
</script>
</body>
</html>
